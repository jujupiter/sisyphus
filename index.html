<html>
	<head>
		<meta charset="utf-8">
		<title>SISYphus</title>
		<link rel="stylesheet" type="text/css" href="css/sisyphus.css" />
		<script src="http://d3js.org/d3.v3.min.js"></script>
		<script src="http://d3js.org/queue.v1.min.js"></script>
		<script src="http://d3js.org/topojson.v1.min.js"></script>
		<script type="text/javascript">
			var Settings = {
				userId: 'jujupiter',
				thumbnail: {
					size: 40,
					border: 1
				},
				diameter: 350,
				margin: 0
			};
		</script>
		<script src="js/Array.prototype.js"></script>
		<script src="js/Globe.js"></script>
		<script src="js/Location.js"></script>
		<script src="js/Album.js"></script>
	</head>
	<body>
		<div id="playground">
			<canvas></canvas>
			<div id="poster">
				<div id="locationName"></div>
				<div id="albumTitle"></div>
			</div>
		</div>
		<a class="pauser">Pause</a>
		<script type="text/javascript">
			
			// Automated settings, do not change
			Settings.thumbnail.effectiveSize = (Settings.thumbnail.border * 2) + Settings.thumbnail.size;
			Settings.thumbnail.ratio = 1 - (Settings.thumbnail.effectiveSize / Settings.diameter);
			
			var paused = false;
			var globe = new Globe('div#playground', Settings.diameter, Settings.margin, 0, 0);
			var currentlyShown = null;

			queue()
				.defer(d3.json, "json/political.json")
				.defer(d3.json, "https://picasaweb.google.com/data/feed/api/user/"+Settings.userId+"?alt=json")
				.defer(d3.json, "location.php?action=listing")
				.await(ready);
			
			function locationsReady() {
				if(!globe.locations.containsItemWith('known', false)) {
					globe.removeEmptyAndInvalidLocations();
					globe.display();
				}
			}
			
			function ready(error, world, albums, loadedLocations) {
				globe.defineLocationList(loadedLocations.locations);
			    globe.land = topojson.feature(world, world.objects.land);
			    var albums = albums.feed.entry;
			    for(var i=0; i<albums.length; i++) {
					if(albums[i]['gphoto$location']['$t']!="") {
						var index = globe.locations.getIndexBy('name', albums[i]['gphoto$location']['$t']);
						// If the location is not known, add it
						if(index==-1) {
							globe.locations.push(new Location(albums[i]['gphoto$location']['$t'], null, null, false, null));
							index = globe.locations.getIndexBy('name', albums[i]['gphoto$location']['$t']);
						}
						globe.locations[index].albums.push(new Album(albums[i]));
					}
			    }
				globe.locations.callMethodForAll('known', false, 'requestCoordinates', locationsReady);
			}
			
			d3.select('.pauser').on('click', function() {
				paused = !paused;
			});
		</script>
	</body>
</html>