<html>
	<head>
		<meta charset="utf-8">
		<title>SISYphus</title>
		<link rel="stylesheet" type="text/css" href="css/sisyphus.css" />
		<script src="http://d3js.org/d3.v3.min.js"></script>
		<script src="http://d3js.org/queue.v1.min.js"></script>
		<script src="http://d3js.org/topojson.v1.min.js"></script>
		<script type="text/javascript">
			var Settings = {
				userId: 'jujupiter',
				thumbnail: {
					size: 40,
					border: 1,
				},
				loadAnim: {
					img: new Image(),
					border: null
				},
				diameter: 350,
				margin: 0
			};
		</script>
		<script src="js/Array.prototype.js"></script>
		<script src="js/Globe.js"></script>
		<script src="js/Location.js"></script>
		<script src="js/Album.js"></script>
	</head>
	<body>
		<div id="playground">
			<canvas></canvas>
			<div id="poster">
				<div id="locationName"></div>
				<div id="albumTitle"></div>
			</div>
		</div>
		<a id="pauser">Pause</a>
		<img id="loader" src="img/loading.gif" width="30" height="30" />
		<script type="text/javascript">
			
			// Automated settings, do not change
			Settings.thumbnail.effectiveSize = (Settings.thumbnail.border * 2) + Settings.thumbnail.size;
			Settings.thumbnail.ratio = 1 - (Settings.thumbnail.effectiveSize / Settings.diameter);
			
			// Global variables
			var paused = false;
			var globe = new Globe('div#playground', Settings.diameter, Settings.margin, 0, 0);
			var currentlyShown = null;
			
			// Launch
			function launch() {
				Settings.loadAnim.border = Settings.thumbnail.size + Settings.thumbnail.border - Settings.loadAnim.width;
				queue()
					.defer(d3.json, "json/political.json")
					.defer(d3.json, "https://picasaweb.google.com/data/feed/api/user/"+Settings.userId+"?alt=json")
					.defer(d3.json, "location.php?action=listing")
					.await(ready);
			}
			Settings.loadAnim.img.onload = launch;
			Settings.loadAnim.img.src = 'img/loading.gif';
			
			function locationsReady() {
				if(!globe.locations.containsItemForWhich('isKnown', false)) {
					globe.removeEmptyAndInvalidLocations();
					console.log('hey', globe.locations);
					globe.display();
				}
			}
			
			function ready(error, world, albums, loadedLocations) {
				globe.defineLocationList(loadedLocations.locations);
			    globe.land = topojson.feature(world, world.objects.land);
			    var albums = albums.feed.entry;
			    for(var i=0; i<albums.length; i++) {
					if(albums[i]['gphoto$location']['$t']!="") {
						var index = globe.locations.getIndexBy('name', albums[i]['gphoto$location']['$t']);
						// If the location is not known, add it
						if(index==-1) {
							globe.locations.push(new Location(albums[i]['gphoto$location']['$t'], null, null, null, globe));
							index = globe.locations.getIndexBy('name', albums[i]['gphoto$location']['$t']);
						}
						globe.locations[index].albums.push(new Album(albums[i]));
					}
			    }
				globe.locations.callMethodForAllWhich('isKnown', false, 'requestCoordinates', locationsReady);
			}
			
			d3.select('#pauser').on('click', function() {
				paused = !paused;
			});

		</script>
	</body>
</html>